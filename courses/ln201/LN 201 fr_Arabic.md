# مقدمة نظرية لشبكة البرق

الهدف: اكتشاف شبكة البرق من الناحية التقنية
الأهداف:
- فهم كيفية عمل قنوات الشبكة.
- التعرف على المصطلحات المتعلقة بـ HTLC و LNURL و UTXO.
- فهم إدارة السيولة والرسوم في LNN.
- التعرف على شبكة البرق كشبكة.
- فهم الاستخدامات النظرية لشبكة البرق.

# رحلة إلى الطبقة الثانية من بيتكوين

هذا الدورة هي دورة نظرية حول كيفية عمل شبكة البرق من الناحية التقنية.

مرحبًا بك في عالم شبكة البرق المثيرة، وهي طبقة ثانوية لبيتكوين، والتي تعتبر تقدمًا تكنولوجيًا معقدًا وغنيًا بالإمكانيات. نحن على وشك الغوص في التفاصيل التقنية لهذه التكنولوجيا، دون التركيز على البرامج التعليمية أو السيناريوهات الخاصة بالاستخدامات المحددة. للاستفادة الكاملة من هذه الدورة، فإن فهم قوي لبيتكوين ضروري. إنها تجربة تتطلب نهجًا جادًا ومركزًا. يمكنك أيضًا النظر في اتباع الدورة LN 202 بالتوازي، والتي تقدم جانبًا أكثر عملية لهذا الاستكشاف. استعد للانطلاق في رحلة قد تغير تصورك عن نظام بيتكوين.

استمتع بالاكتشاف!

+++

# الأساسيات

## فهم شبكة البرق

![فهم شبكة البرق](https://youtu.be/PszWk046x-I)

شبكة البرق هي بنية تحتية للدفع من الطبقة الثانية، مبنية على شبكة بيتكوين، والتي تتيح المعاملات السريعة والرخيصة. لفهم كيفية عمل شبكة البرق بشكل كامل، من الضروري فهم ما هي قنوات الدفع وكيفية عملها.

قناة الدفع في البرق هي نوع من "الممر الخاص" بين مستخدمين اثنين، والذي يتيح المعاملات السريعة والمتكررة لبيتكوين. عند فتح قناة، يتم تخصيص سعة ثابتة لها، والتي يتم تحديدها مسبقًا من قبل المستخدمين. هذه السعة تمثل الحد الأقصى للبيتكوين التي يمكن نقلها في القناة في أي وقت.

قنوات الدفع ثنائية الاتجاه، مما يعني أن لديها جانبين "متضادين". على سبيل المثال، إذا فتحت أليس وبوب قناة دفع، يمكن لأليس إرسال بيتكوين إلى بوب وبوب يمكنه إرسال بيتكوين إلى أليس. المعاملات داخل القناة لا تؤثر على السعة الإجمالية للقناة، ولكنها تؤثر على توزيع هذه السعة بين أليس وبوب.

![شرح](assets/chapitre1/0.JPG)

لكي تكون المعاملة ممكنة في قناة الدفع في البرق، يجب أن يكون للمستخدم الذي يرسل الأموال ما يكفي من بيتكوين في جانبه من القناة. إذا كانت أليس ترغب في إرسال 1 بيتكوين إلى بوب عبر قناتهما، يجب أن يكون لديها على الأقل 1 بيتكوين في جانبها من القناة.

حدود وعمل قنوات الدفع في البرق
على الرغم من أن سعة قناة الدفع البرقية ثابتة، إلا أن ذلك لا يحد من عدد العمليات الإجمالية أو حجم البيتكوين الإجمالي الذي يمكن نقله عبر القناة. على سبيل المثال، إذا كانت لدى أليس وبوب قناة بسعة 1 بيتكوين، فيمكنهما إجراء مئات العمليات بقيمة 0.01 بيتكوين أو آلاف العمليات بقيمة 0.001 بيتكوين، طالما لم يتم تجاوز السعة الإجمالية للقناة في أي وقت ما.

على الرغم من هذه القيود، تعد قنوات الدفع البرقية وسيلة فعالة لإجراء عمليات بيتكوين سريعة ورخيصة. فهي تتيح للمستخدمين إرسال واستقبال البيتكوين دون الحاجة إلى دفع رسوم مرتفعة أو الانتظار لفترات طويلة لتأكيد العملية على شبكة البيتكوين.

باختصار، توفر قنوات الدفع عبر البرق حلاً قويًا لأولئك الذين يرغبون في إجراء عمليات بيتكوين سريعة ورخيصة. ومع ذلك، فمن الضروري فهم كيفية عملها وقيودها للاستفادة منها بشكل كامل.

![explication](assets/chapitre1/1.JPG)

مثال:

- أليس لديها 100،000 ساتوشي
- بوب لديه 30،000 ساتوشي

هذا هو الحال الحالي للقناة. في عملية ما، تقرر أليس إرسال 40،000 ساتوشي إلى بوب. يمكنها ذلك لأن 40،000 < 100،000.

لذا، يكون الحالة الجديدة للقناة كالتالي:

- أليس 60،000 ساتوشي
- بوب 70،000 ساتوشي

```
الحالة الأولية للقناة:
أليس (100،000 ساتوشي) ============== بوب (30،000 ساتوشي)

بعد تحويل 40،000 ساتوشي من أليس إلى بوب:
أليس (60،000 ساتوشي) ============== بوب (70،000 ساتوشي)

```

![explication](assets/chapitre1/2.JPG)

الآن، يرغب بوب في إرسال 80،000 ساتوشي إلى أليس. ولكنه ليس لديه السيولة الكافية لذلك. السعة القصوى للقناة هي 130،000 ساتوشي، مع إمكانية إنفاق 60،000 ساتوشي لأليس و 70،000 ساتوشي لبوب.

![explication](assets/chapitre1/3.JPG)

## البيتكوين والعناوين وUTXO والمعاملات

![bitcoin, adresses, utxo et transactions](https://youtu.be/cadCJ2V7zTg)

في هذا الفصل الثاني، سنستغرق بعض الوقت لفهم كيفية عمل معاملات البيتكوين بالفعل، وهذا سيكون مفيدًا جدًا لفهم البرق. سنتطرق أيضًا إلى مفهوم العنوان متعدد التوقيع، والذي يعد أمرًا حاسمًا لفهم الفصل التالي المخصص لفتح قنوات على شبكة البرق.

- المفتاح الخاص> المفتاح العام> العنوان: عند إجراء معاملة، ترسل أليس المال إلى بوب. يقدم بوب عنوانًا معينًا من خلال المفتاح العام الخاص به. ثم تستخدم أليس المفتاح الخاص الخاص بها لتوقيع المعاملة وبالتالي فتح البيتكوين الموجودة في العنوان.
- خلال عملية تحويل في بيتكوين، يجب أن تتحرك جميع البتكوينات. يُطلق عليها UTXO (إخراج تحويل غير مُنفق)، حيث تتحرك جميع قطع البتكوين وتعود بعد ذلك إلى صاحبها:
أليس لديها 0.002 بتكوين، وبوب ليس لديه أي بتكوين. تقرر أليس إرسال 0.0015 بتكوين إلى بوب. ستوقع على عملية تحويل بقيمة 0.002 بتكوين حيث ستذهب 0.0015 إلى بوب وستعود 0.0005 إلى محفظتها.

هنا، لدينا UTXO واحدة (أليس لديها 0.0002 بتكوين في عنوان)، لذا قمنا بإنشاء 2 UTXO (بوب لديه 0.0015 بتكوين وأليس استعادت UTXO جديدة (مستقلة عن السابقة) بقيمة 0.0005 بتكوين).

```
أليس (0.002 بتكوين)
  |
  V
عملية تحويل بيتكوين (0.002 بتكوين)
  |
  |----> بوب (0.0015 بتكوين)
  |
  V
أليس (UTXO جديدة: 0.0005 بتكوين)
```

في شبكة البرق، نستخدم توقيعات متعددة. لذا، يجب أن يكون هناك توقيعان لفتح الأموال، أي اثنتان من المفاتيح الخاصة لنقل الأموال. يمكن أن تكون أليس وبوب معًا هما اللذان يجب أن يوافقا على فتح الأموال (UTXO). في LN بالتحديد، هذه هي عمليات التحويل 2/2، لذا يجب أن يكون هناك توقيعان بالضرورة مقابل التوقيعات المتعددة 2/3 أو 3/5 حيث يكفي توقيع مجموعة كاملة من المفاتيح.

![explication](assets/chapitre2/1.JPG)

# فتح وإغلاق القنوات

## فتح القناة

![ouvrir un canal](https://youtu.be/B2caBC0Rxko)

الآن، سنتناول فتح القناة بشكل أكثر تفصيلًا وكيفية تنفيذها من خلال عملية تحويل بيتكوين.

شبكة البرق لديها مستويات مختلفة من التواصل:

- التواصل نقطة إلى نقطة (بروتوكول شبكة البرق)
- قناة الدفع (بروتوكول شبكة البرق)
- عملية تحويل بيتكوين (بروتوكول بيتكوين)

![explication](assets/chapitre3/0.JPG)

لفتح قناة، يتحدث الزوجان عبر قناة اتصال:

- أليس: "مرحبًا، أريد فتح قناة!"
- بوب: "حسنًا، هذا هو عنواني العام."

![explication](assets/chapitre3/1.JPG)

أليس الآن لديها عنوانين عامين لإنشاء عنوان متعدد التوقيع 2/2. يمكنها الآن إجراء عملية تحويل بيتكوين لإرسال الأموال إليه.

لنفترض أن أليس لديها UTXO بقيمة 0.002 بتكوين وترغب في فتح قناة مع بوب بقيمة 0.0013 بتكوين. ستقوم بإنشاء عملية تحويل مع 2 UTXO كمخرجات:

- UTXO بقيمة 0.0013 إلى عنوان متعدد التوقيع 2/2
- UTXO بقيمة 0.0007 إلى أحد عناوين الصرف الخاصة بها (عودة الـ UTXO).
هذه المعاملة لم تصبح عامة بعد لأنه إذا كانت كذلك في هذه المرحلة، فإنها تعتمد على بوب لفتح الأموال المتعددة التوقيع.
ولكن كيف يمكن ذلك؟

سوف تقوم أليس بإنشاء معاملة ثانية تسمى "معاملة السحب" قبل نشر إيداع الأموال في المتعدد التوقيع.

ستنفق معاملة السحب الأموال من عنوان المتعدد التوقيع إلى عنوانها (هذا قبل أن يتم نشر أي شيء).

بمجرد بناء المعاملتين، تخبر بوب أنه تم ذلك وتطلب منه توقيعًا بمفتاحه العام مع شرح لها بأنها ستتمكن بذلك من استعادة أموالها إذا حدث شيء سيء. يوافق بوب لأنه ليس غير أمين.

بالتالي، يمكن لأليس استعادة الأموال بمفردها، لديها بالفعل توقيع بوب. لذا، تقوم بنشر المعاملات. تم فتح القناة الآن مع 0.0013 بيتكوين (130000 ساتوشي) من جانب أليس.

الآن، دعنا نحلل ما يحدث في الخلفية عند نقل الأموال من جانب إلى آخر في قناة على شبكة البرق، بما في ذلك مفهوم معاملة الالتزام. تعبر المعاملة الخارجة/الإغلاق على السلسلة عن حالة القناة، وهذا يضمن من يمتلك الأموال بعد كل نقل.

لذا بعد نقل على شبكة البرق، يتم تحديث هذه المعاملة/الاتصال غير المنفذ بين الزوجين، أليس وبوب يقومان بإنشاء نفس المعاملة مع الحالة الحالية للقناة في حالة الإغلاق:

- تقوم أليس بإنشاء قناة مع بوب بـ 130000 ساتوشي من جانبها. تقول معاملة السحب الموافق عليها من قبل الطرفين في حالة الإغلاق أن 130000 ساتوشي ستذهب إلى أليس عند الإغلاق، ويوافق بوب على ذلك لأنه عادل.

- ترسل أليس 30000 ساتوشي إلى بوب. لذا، هناك معاملة سحب جديدة تقول أنه في حالة الإغلاق، ستحصل أليس على 100000 ساتوشي وبوب على 30000 ساتوشي. يوافق الطرفان على ذلك لأنه عادل.

- ترسل أليس 10000 ساتوشي إلى بوب، وتتم إنشاء معاملة سحب جديدة مرة أخرى لتقول أن أليس ستسترد 90000 ساتوشي وبوب 40000 ساتوشي. يوافق الطرفان على ذلك لأنه عادل.

الحالة الأولية للقناة:
أليس (130000 ساتوشي) =============== بوب (0 ساتوشي)

بعد النقل الأول:
أليس (100000 ساتوشي) =============== بوب (30000 ساتوشي)

بعد النقل الثاني:
أليس (90000 ساتوشي) =============== بوب (40000 ساتوشي)
لا يتحرك المال أبدًا ولكن الرصيد النهائي يتحديث من خلال صفقة موقعة ولكن غير منشورة على السلسلة الرئيسية. لذلك فإن صفقة السحب هي في الواقع صفقة التزام. تعتبر تحويلات الساتوشي صفقة التزام أحدث التي تحديث الرصيد.
## صفقات التزام

إذا كانت صفقات الالتزام تحدد حالة القناة مع السيولة في اللحظة X، هل يمكن الغش عن طريق نشر حالة قديمة وبالتالي حالة قديمة؟ الإجابة هي نعم لأن لدينا بالفعل توقيع مسبق من الطرفين في الصفقة غير المنشورة.

لحل هذه المشكلة، سنضيف تعقيدًا:

- Timelock = الأموال محجوزة حتى الكتلة N
- مفتاح الإبطال = سر أليس وسر بوب

تمت إضافة هاتين العنصرين إلى صفقة الالتزام. وبالتالي، يجب على أليس الانتظار حتى نهاية Timelock، ويمكن لأي شخص يمتلك مفتاح الإبطال نقل الأموال دون الانتظار حتى نهاية Timelock. إذا حاولت أليس الغش، يستخدم بوب مفتاح الإبطال لسرقة أموال أليس ومعاقبتها.

الآن (وفي الواقع)، ليست صفقة الالتزام هي نفسها لأليس وبوب، إنهما متماثلتان ولكن لكل منهما قيود مختلفة، يتبادلان أسرارهما لإنشاء مفتاح الإبطال لصفقة الالتزام السابقة. لذا عند الإنشاء، تقوم أليس بإنشاء القناة مع بوب، 130،000 سات من جانبها، لديها Timelock يمنعها من استرداد أموالها فورًا، يجب عليها الانتظار قليلاً. يمكن لمفتاح الإبطال فتح الأموال ولكنها فقط لديها أليس (صفقة الالتزام لأليس). بمجرد وجود تحويل، ستقدم أليس سرها القديم لبوب وبالتالي يمكن لبوب في حالة الغش تفريغ القناة إلى الحالة السابقة في حالة محاولة أليس الغش (يتم معاقبة أليس بالتالي).

بنفس الطريقة، سيقدم بوب سره لأليس. حتى إذا حاول بوب الغش، يمكن لأليس معاقبته. يتكرر العملية مع كل صفقة جديدة للالتزام. يتم تحديد سر جديد ومفتاح إبطال جديد. لذا لكل صفقة جديدة، يجب تدمير صفقة الالتزام السابقة عن طريق تقديم سر الإبطال. وبالتالي، إذا حاولت أليس أو بوب الغش، يمكن للطرف الآخر التصرف قبله (بفضل Timelock) وبالتالي تجنب الغش. خلال الصفقة رقم 3، نقدم سر الصفقة رقم 2 للسماح لأليس وبوب بالدفاع عن أنفسهم في مواجهة أليس أو بوب.


الشخص الذي يقوم بإنشاء المعاملة باستخدام Timelock (الشخص الذي يرسل المال) يمكنه استخدام مفتاح الإلغاء فقط بعد Timelock. ومع ذلك ، يمكن للشخص الذي يستلم المال استخدامه قبل Timelock في حالة وجود خداع من جانب إحدى الأطراف في قناة على شبكة البرق. على وجه الخصوص ، نشرح بالتفصيل آليات الحماية من أي خداع محتمل من قبل الشريك في القناة.

## إغلاق القناة

![إغلاق القناة](https://youtu.be/FVmQvNpVW8Y)

نهتم بإغلاق القناة من خلال معاملة بيتكوين ، والتي يمكن أن تأخذ أشكالًا مختلفة حسب الحالة. هناك 3 أنواع من إغلاق القناة:

- الجيد: إغلاق تعاوني
- الوحش: إغلاق قسري (غير تعاوني)
- الغشاش: إغلاق بواسطة خادع

### الجيد

يتحدث الزوجان ويتفقان على إغلاق القناة. يتوقفان عن جميع المعاملات ويقومان بتأكيد حالة نهائية للقناة. يتفقان على رسوم الشبكة (الشخص الذي يفتح القناة يدفع رسوم الإغلاق). يقومان الآن بإنشاء معاملة الإغلاق. لذلك ، هناك معاملة إغلاق مختلفة عن معاملات الالتزام لأنه لا يوجد Timelock ومفتاح إلغاء. يتم نشر المعاملة ويتلقى أليس وبوب أرصدتهما على التوالي. هذا النوع من الإغلاق سريع (لأنه لا يوجد Timelock) وغالبًا ما يكون رخيصًا.

### الوحش

أليس تريد إغلاق القناة ، ولكنها لا تحصل على رد من بوب لأنه غير متصل بالإنترنت (انقطاع الاتصال أو انقطاع التيار الكهربائي). لذا ، ستقوم أليس بنشر أحدث معاملة الالتزام (الأخيرة). يتم نشر المعاملة ويتم تنشيط Timelock. بالتالي ، تم تحديد الرسوم عند إنشاء هذه المعاملة قبل X وقت في الماضي! تغيرت MemPool منذ ذلك الحين ، حيث يستخدم البروتوكول افتراضيًا رسومًا تكون أعلى بخمسة أضعاف من الرسوم الحالية عند إنشاء المعاملة. تم إنشاء رسوم بقيمة 10 SAT لذلك تم اعتبار المعاملة 50 SAT. عند النشر بشكل قسري ، فإن معاملة الإغلاق في الشبكة هي:

- 1 SAT = مدفوعة بزيادة 50 مرة
- 100 SAT = غير مدفوعة بنسبة 2 مرات

بالتالي ، يجعل الإغلاق القسري أطول (Timelock) وخاضعًا للمزيد من المخاطر من حيث الرسوم وبالتالي قابلية التحقق من قبل المنقبين.

### الغشاش
تحاول آليس الغش عن طريق نشر معاملة تزامن قديمة. لكن بوب يراقب ميمبول وينتظر وجود معاملات تحاول نشر معاملات قديمة. إذا وجد ذلك، فإنه يستخدم مفتاح الإلغاء لمعاقبة آليس وأخذ جميع الـ SAT من القناة.

للخلاصة، إغلاق القناة في شبكة البرق هو خطوة حاسمة يمكن أن تأخذ أشكالًا مختلفة. في إغلاق تعاوني، يتواصل الطرفان ويتفقان على حالة نهائية للقناة. هذا هو الخيار الأسرع والأقل تكلفة. بالمقابل، يحدث الإغلاق القسري عندما يكون أحد الأطراف غير مستجيب. إنها حالة أكثر تكلفة وأطول بسبب رسوم المعاملة غير المتوقعة وتنشيط Timelock. أخيرًا، إذا حاول أحد المشاركين الغش عن طريق نشر معاملة تزامن قديمة، فيمكن معاقبته وفقدان جميع الـ SAT من القناة. لذا فمن المهم فهم هذه الآليات لاستخدام فعال وعادل لشبكة البرق.

# شبكة سيولة

## شبكة البرق

في هذا الفصل السابع، سندرس كيفية عمل البرق كشبكة من القنوات وكيفية توجيه المدفوعات من مصدرها إلى وجهتها.

البرق هو شبكة من قنوات الدفع. لذلك، هناك آلاف الأزواج مع قنوات سيولة تتصل ببعضها البعض وتستخدم بشكل ذاتي لإجراء المعاملات بين الأطراف غير المتصلة.

لا يمكن نقل سيولة القنوات إلى قنوات أخرى من السيولة.

`آليس -> إيدين -> بوب`. لم تتحرك الساتوشي من `آليس -> بوب`، ولكن من `آليس -> إيدين` ومن `إيدين -> بوب`.

لذلك، لكل شخص وقنوات سيولة مختلفة. لإجراء المدفوعات، يجب أن تجد طريقًا في الشبكة مع كمية كافية من السيولة. إذا كان هناك نقص في السيولة، فلن يتم إتمام المدفوعة.

لنأخذ الشبكة التالية كمثال:

```
الحالة الأولية للشبكة:
آليس (130 سات) ==== (0 سات) سوزي (90 سات) ==== (200 سات) إيدين (150 سات) ==== (100 سات) بوب
```

إذا أرادت آليس نقل 40 سات إلى بوب، سيتم إعادة توزيع السيولة على طول الطريق بين الطرفين.

```
بعد نقل 40 سات من آليس إلى بوب:
آليس (90 سات) ==== (40 سات) سوزي (50 سات) ==== (240 سات) إيدين (110 سات) ==== (140 سات) بوب
```
ومع ذلك ، في الحالة الأولية ، لا يمكن لـ بوب أن يرسل 40 SAT إلى أليس لأن سوزي ليس لديها سيولة مع أليس لإرسال 40 SAT إليها ، لذلك لا يمكن إجراء الدفع عبر هذا الطريق. لذا ، يجب أن يكون هناك طريق آخر حيث يكون التحويل غير ممكن.
في المثال الأول ، نلاحظ أن سوزي وإيدن لم يفقدوا أو يكسبوا شيئًا. لقبول استخدامهما لتوجيه التحويلة ، يطلب شبكة البرق رسومًا!

هناك رسوم مختلفة اعتمادًا على مكان السيولة

أليس - بوب

- رسوم أليس = أليس -> بوب
- رسوم بوب = بوب -> أليس

![cover](assets/Chapitre7/5.JPG)


هناك نوعان من الرسوم:

- رسوم ثابتة بغض النظر عن المبلغ: 1 SAT (افتراضيًا ولكن قابل للتعديل)
- رسوم متغيرة (0.01٪ افتراضيًا)

مثال على الرسوم:

- أليس - سوزي ؛ 1/1 (1 في الرسوم الثابتة و 1 في الرسوم المتغيرة)
- سوزي - إيدن ؛ 0/200
- إيدن - بوب ؛ 1/1

لذلك:

- رسوم 1: (يدفعها أليس لنفسها) 1 + (40،000 / * 0.000001)
- رسوم 2: 0 + 40،000 / * 0.0002 = 8 SAT
- رسوم 3: 1 + 40،000 / * 0.000001 = 0.4 SAT

![cover](assets/Chapitre7/6.JPG)

إرسال:

1. إرسال 40،009.04 أليس -> سوزي ؛ أليس تدفع رسومها لنفسها لذلك لا يحتسب ذلك
2. سوزي تقوم بإرسال 40،001.04 إلى إيدن ، وهي تأخذ عمولتها من 8 SAT
3. إيدن يقوم بإرسال 40،000 إلى بوب ، وهو يأخذ 1.04 SAT من رسومه.

دفعت أليس 9.04 SAT كرسوم وتلقى بوب 40،000 SAT.

![cover](assets/Chapitre7/7.JPG)

في LN ، يقرر عقد أليس المسار قبل الإرسال. لذا ، هناك بحث عن أفضل طريقة وأليس هي الوحيدة التي تعرف الطريقة والسعر. يتم إرسال الدفعة ولكن سوزي ليس لديها معلومات.

![cover](assets/Chapitre7/9.JPG)

بالنسبة لسوزي أو إيدن: فهم لا يعرفون من هو المستلم النهائي أو من هو الشخص الذي يرسل. هذا هو التوجيه بالبصل. يجب على العقد الاحتفاظ بخريطة الشبكة للعثور على طريقته ، ولكن ليس لدى أي من الوسطاء أي معلومات.

## HTLC - عقد مؤمن بالوقت المحدد والتجزئة

![HTLC](https://youtu.be/-JC4mkq7H48)

في نظام التوجيه التقليدي ، كيف يتم التأكد من أن إيدن لا يغش ويحترم جزءه من العقد؟

HTLC هو عقد دفع يمكن فتحه فقط بواسطة سر. إذا لم يتم الكشف عنه ، فإن العقد ينتهي صلاحيته. لذا ، إنها دفعة مشروطة. كيف يتم استخدامها؟
لنأخذ الحالة التالية:
`أليس (100،000 ساتوشي) ==== (30،000 ساتوشي) سوزي (250،000 ساتوشي) ==== (0 ساتوشي) بوب`

- بوب ينشئ سرًا S (الصورة الأصلية) ويحسب الهاش r = hash (s)
- بوب يرسل فاتورة إلى أليس تحتوي على "r" على وجه الخصوص
- أليس ترسل HTLC بقيمة 40،000 ساتوشي إلى سوزي مع شرط الكشف عن "s'" حيث hash (s') = r
- سوزي ترسل HTLC مماثلة إلى بوب
- بوب يقوم بفتح HTLC لسوزي عن طريق عرض "s"
- سوزي تفتح HTCL لأليس عن طريق عرض "S"

إذا كان بوب غير متصل بالإنترنت ولم يستلم أبدًا السر الذي يمنحه الشرعية لاستلام المال ، في هذه الحالة سينتهي ال HTLC بعد عدد معين من الكتل.

تنتهي HTLC بالترتيب من الأخير إلى الأول: إذا انتهت صلاحية سوزي - بوب ثم أليس - سوزي.
بهذه الطريقة ، إذا عاد بوب ، فلن يتغير شيء. وفي الحالة العكسية ، إذا قامت أليس بإلغاء الأمر عندما يعود بوب ، فسيكون الأمر فوضى وقد يكون الناس قد عملوا لاشيء.

حسنًا ، ماذا يحدث عند الإغلاق؟ في الواقع ، تعقد صفقات الالتزام لدينا أكثر تعقيدًا. يجب تمثيل الرصيد الوسيط إذا تم إغلاق القناة.

لذا ، هناك HTLC-out بقيمة 40،000 ساتوشي (مع القيود المذكورة سابقًا) في صفقة الالتزام من خلال الإخراج رقم 3.

لذا ، لدى أليس في صفقة الالتزام:

- الإخراج رقم 1: 60،000 ساتوشي لأليس عن طريق Timelock ومفتاح الإبطال (ما تبقى لها)
- الإخراج رقم 2: 30،000 ساتوشي تملكها بالفعل سوزي
- الإخراج رقم 3: 40،000 ساتوشي في HTLC

صفقة الالتزام لأليس تحتوي على HTCL-out لأنها ترسل HTLC-in إلى المستلمة ، سوزي.

لذا ، إذا نشرنا صفقة الالتزام هذه ، يمكن لسوزي استلام أموال HTCL مع الصورة "s". إذا لم تكن لديها الصورة الأصلية ، فسوف تسترد أليس الأموال بمجرد انتهاء صلاحية HTCL. فكر في الإخراجات (UTXO) كدفعات مختلفة بشروط مختلفة.
بمجرد تمرير الدفعة (انتهاء الصلاحية أو التنفيذ) ، يتغير حالة القناة ولا تعود صفقة مع HTCL موجودة. نعود إلى شيء تقليدي.
في حالة الإغلاق التعاوني: نتوقف عن الدفعات وبالتالي ننتظر تنفيذ التحويلات / HTCL ، والصفقة خفيفة لذا أقل تكلفة لأنها تحتوي على الحد الأقصى لإخراج واحد أو اثنين.

في حالة الإغلاق القسري: ننشر مع جميع HTLC المستمرة ، لذا يصبح الأمر ثقيلاً جدًا ومكلفًا جدًا. وهذا الأمر فوضى.
باختصار، يستخدم نظام توجيه شبكة البرق عقود الهاش المقفلة بالوقت (HTLC) لضمان دفع آمن وقابل للتحقق. تتيح عقود HTLC إجراء مدفوعات مشروطة حيث لا يمكن فتح الأموال إلا بوجود سر، مما يضمن أن المشاركين يلتزمون بالتزاماتهم. في المثال المقدم، ترغب أليس في إرسال SAT إلى بوب عبر سوزي. يقوم بوب بإنشاء سر وإنشاء هاش له وينقله إلى أليس. يقومت أليس وسوزي بإنشاء HTLC بناءً على هذا الهاش. بمجرد أن يفتح بوب HTLC لسوزي عن طريق إظهار السر، يمكن لسوزي بعد ذلك فتح HTLC لأليس.

في حالة عدم كشف بوب للسر في فترة زمنية معينة، ينتهي ال HTLC. يحدث الانتهاء في ترتيب من الأخير إلى الأول، مما يضمن أنه إذا عاد بوب عبر الإنترنت، لا توجد عواقب غير مرغوب فيها.

عند إغلاق القناة، إذا كان إغلاقًا تعاونيًا، يتم إيقاف الدفعات ويتم حل HTLCs، وهو عادة أقل تكلفة. إذا تم إغلاقها بالقوة، يتم نشر جميع عمليات HTLC المستمرة، وهو ما يمكن أن يصبح مكلفًا وفوضويًا للغاية. بشكل عام، يضيف آلية HTLC طبقة إضافية من الأمان في شبكة البرق، مما يضمن تنفيذ الدفعات بشكل صحيح واحترام المستخدمين لالتزاماتهم.

## العثور على الطريق

![trouver sa voie](https://youtu.be/wnUGJjOxd9Q)

المعلومات العامة الوحيدة هي القدرة الإجمالية للقناة (أليس + بوب) ولكننا لا نعرف أين يتواجد السيولة. للحصول على مزيد من المعلومات، يستمع عقدنا إلى قناة اتصال LN لإعلان قنوات جديدة وتحديثات رسوم القنوات. يراقب عقدك أيضًا سلسلة الكتل لإغلاق القنوات.

نظرًا لعدم حصولنا على جميع المعلومات، يجب أن نبحث في الرسم/المسار بناءً على المعلومات التي لدينا (القدرة القصوى للقنوات وليس مكان السيولة).

المعايير:

- احتمالية النجاح
- الرسوم
- مهلة انتهاء HTLC
- عدد العقد الوسيطة
- عشوائي

![graph](assets/chapitre9/1.JPG)

لذلك إذا كان هناك 3 مسارات ممكنة:

- أليس > 1 > 2 > 5 > بوب
- أليس > 1 > 2 > 4 > 5 > بوب
- أليس > 1 > 2 > 3 > بوب

نبحث عن أفضل مسار نظريًا بأقل رسوم وأكبر فرصة للنجاح: أقصى سيولة وأقل عدد من القفزات.

على سبيل المثال، إذا كان لدى 2-3 سعة قناة تبلغ 130،000 SAT، فإن إرسال 100،000 SAT غير محتمل جدًا، لذا فإن الخيار رقم 3 ليس لديه فرص نجاح.

![graph](assets/chapitre9/2.JPG)
الآن، قام الخوارزمية بعمل 3 اختيارات وسوف تجرب الأولى:
الاختيار 1:
- أليس ترسل HTCL بقيمة 100،000 ساتوشي إلى 1.
- العقدة 1 تقوم بإنشاء HTLC بقيمة 100،000 ساتوشي للعقدة 2.
- العقدة 2 تقوم بإنشاء HTLC بقيمة 100،000 ساتوشي للعقدة 5، ولكن العقدة 5 غير قادرة على ذلك، لذا يتم الإعلان عن الفشل.

تم إعادة إرسال المعلومات، لذا يقرر أليس تجربة الطريقة الثانية:
- أليس ترسل HTLC بقيمة 100،000 ساتوشي إلى 1.
- العقدة 1 تقوم بإنشاء HTLC بقيمة 100،000 ساتوشي للعقدة 2.
- العقدة 2 تقوم بإنشاء HTLC بقيمة 100،000 ساتوشي للعقدة 4.
- العقدة 4 تقوم بإنشاء HTLC بقيمة 100،000 ساتوشي لبوب. بوب لديه السيولة، لذا فهذا مقبول.
- بوب يستخدم الـ preimage (hash) لـ HTLC وبالتالي يستخدم السر لاسترداد 100،000 ساتوشي.
- العقدة 5 لديها الآن السر لـ HTLC لاسترداد HTLC المحجوزة من العقدة 4.
- العقدة 4 لديها الآن السر لـ HTLC لاسترداد HTLC المحجوزة من العقدة 2.
- العقدة 2 لديها الآن السر لـ HTLC لاسترداد HTLC المحجوزة من العقدة 1.
- العقدة 1 لديها الآن السر لـ HTLC لاسترداد HTLC المحجوزة من أليس.

أليس لم تشهد فشل الطريقة الأولى، فقط انتظرت ثانية إضافية. يحدث فشل الدفع عندما لا يكون هناك طريق ممكنة. لتسهيل البحث عن الطريق، يمكن لبوب تزويد أليس بمعلومات لمساعدتها في فاتورتها:
- المبلغ.
- عنوانه.
- هاش الـ preimage حتى تتمكن أليس من إنشاء HTLC.
- مؤشرات عن قنوات بوب.

بوب يعرف سيولة القنوات 5 و 3 لأنه متصل مباشرة بهما، لذا يمكنه إبلاغ أليس بذلك. يحذر أليس من أن العقدة 3 غير ضرورية، وهذا يمنع أليس من إمكانية استخدامها كطريقة محتملة.
عنصر آخر هو القنوات الخاصة (غير المنشورة على الشبكة) التي يمكن أن يكون لبوب قناة خاصة مع العقدة 1، فيمكنه أن يخبر أليس باستخدامها وبالتالي ستكون السلسلة كالتالي: أليس > 1 > بوب.

في الختام، توجد عملية توجيه المعاملات على شبكة البرق عملية معقدة تتطلب مراعاة عوامل متنوعة. بينما تكون القدرة الإجمالية للقنوات عامة، فإن توزيع السيولة الدقيقة ليست متاحة مباشرة. وهذا يجبر العقد على تقدير الطرق الأكثر احتمالًا للنجاح، مع مراعاة معايير مثل الرسوم، ومهلة انتهاء HTLC، وعدد العقد الوسيطة، وعامل عشوائي.
عندما يكون هناك عدة طرق ممكنة، يحاول العقد تقليل التكاليف وزيادة فرص النجاح عن طريق اختيار القنوات ذات السيولة الكافية والحد الأدنى من القفزات. إذا فشلت محاولة العملية بسبب سيولة غير كافية، يتم تجربة طريق آخر حتى تنجح العملية.

علاوة على ذلك، يمكن للمستلم توفير معلومات إضافية لتسهيل البحث عن الطريق، مثل العنوان والمبلغ وهاش الصورة الأصلية، وتوجيهات حول قنواته. يمكن أن يساعد ذلك في تحديد القنوات ذات السيولة الكافية وتجنب محاولات العمليات غير الضرورية.

في النهاية، يتم تصميم نظام التوجيه في شبكة البرق لتحسين سرعة وأمان وكفاءة العمليات، مع الحفاظ على سرية المستخدمين.

أدوات شبكة البرق
الفاتورة، LNURL، Keysend

الفاتورة (Invoice) هي عبارة عن طلب دفع مكتظ وغير مريح للقراءة، ولكنه يسمح بتمثيل طلب الدفع بشكل كثيف.

مثال:
lnbc1m1pskuawzpp5qeuuva2txazy5g483tuv9pznn9ft8l5e49s5dndj2pqq0ptyn8msdqqcqzpgxqrrsssp5v4s00u579atm0em6eqm9nr7d0vr64z5j2sm5s33x3r9m4lgfdueq9qyyssqxkjzzgx5ef7ez3dks0laxayx4grrw7j22ppgzyhpydtv6hmc39skf9hjxn5yd3kvv7zpjdxd2s7crcnemh2fz26mnr6zu83w0a2fwxcqnvujl3

- lnbc1m = الجزء القابل للقراءة
- 1 = فاصل مع الباقي
- ثم الباقي
- Bc1 = ترميز Bech32 (بنظام الأساس 32)، وبالتالي يتم استخدام 32 حرفًا.
- 10 = 1.2.3.4.5.6.7.8.9.0
- 26 = abcdefghijklmnopqrstuvwxyz
- 32 = ليس "b- i- o" وليس "1"

lnbc1m

- ln = البرق
- Bc = بيتكوين (الشبكة الرئيسية)
- 1 = المبلغ
- M = ميلي (10*-3 / u = ميكرو 10*-6 / n = نانو 10*-9 / p = بيكو 10*-12

هنا 1m = 1 /* 0.0001btc = 100 000 BTC
"طلب منه دفع 100،000 SAT على شبكة البرق الرئيسية لبيتكوين على الشبكة الرئيسية إلى pskuawzpp5qeuuva2txazy5g483tuv9pznn9ft8l5e49s5dndj2pqq0ptyn8msdqqcqzpgxqrrsssp5v4s00u579atm0em6eqm9nr7d0vr64z5j2sm5s33x3r9m4lgfdueq9qyyssqxkjzzgx5ef7ez3dks0laxayx4grrw7j22ppgzyhpydtv6hmc39skf9hjxn5yd3kvv7zpjdxd2s7crcnemh2fz26mnr6zu83w0a2fwxcqnvujl3 »
### الطابع الزمني (عندما تم إنشاؤه)

يحتوي على 0 أو أكثر من الأجزاء الإضافية:

- هاش الصورة الأصلية
- سر الدفع (التوجيه البصلي)
- بيانات تعسفية
- مفتاح LN العام للمستلم
- مدة الصلاحية (افتراضيًا 1 ساعة)
- توجيهات التوجيه
- توقيع الكل

هناك أنواع أخرى من الفواتير. يسمح بروتوكول LNURL بتوفير مبلغ مباشر من الساتوشي بدلاً من طلبه. إنه مرن للغاية ويسمح بالعديد من التحسينات في تجربة المستخدم.

![غلاف](assets/chapitre10/2.JPG)

يتيح Keysend لـ Alice إرسال أموال إلى Bob دون أن يكون لديها طلب من Bob. يحصل Alice على معرف Bob ، وتنشئ صورة أصلية دون أن تطلب من Bob وتضمها في إرسالها. لذلك ، سيتلقى Bob طلبًا مفاجئًا حيث يمكنه فتح الأموال لأن Alice قامت بالفعل بالعمل.

![غلاف](assets/chapitre10/3.JPG)

في الختام ، فإن فاتورة شبكة البرق ، على الرغم من تعقيد المظهر الأولي ، تشفر بشكل فعال طلب الدفع. يحتوي كل قسم من الفاتورة على معلومات رئيسية ، بما في ذلك المبلغ المطلوب دفعه ، والمستلم ، وطابع الزمن للإنشاء ، وربما معلومات أخرى مثل هاش الصورة الأصلية ، وسر الدفع ، وتوجيهات التوجيه ، ومدة الصلاحية. توفر بروتوكولات مثل LNURL و Keysend تحسينات كبيرة في المرونة وتجربة المستخدم ، مما يتيح على سبيل المثال إرسال الأموال بدون طلب مسبق من الطرف الآخر. تجعل هذه التقنيات عملية الدفع أكثر سلاسة وكفاءة على شبكة البرق.

## إدارة السيولة

![gerer sa liquidité](https://youtu.be/YuPrbhEJXbg)

نقدم بعض الإرشادات العامة للتعامل مع مشكلة إدارة السيولة على البرق.

![instruction](assets/chapitre11/0.JPG)

في LN ، هناك 3 أنواع من الأشخاص:

- المشترين: لديهم سيولة صادرة ، وهذا هو الأبسط لأنه يكفي فتح قنوات
- التجار: الأمر أكثر تعقيدًا لأنهم بحاجة إلى سيولة نقدية من خلال عقدات وأطراف أخرى. يجب أن يكون لديهم أشخاص متصلين بهم.
- عقدات التوجيه: يرغبون في أن يكون لديهم توازن في السيولة من الجانبين واتصال جيد بعدد كبير من العقدات لاستخدامها قدر الإمكان.

لذا، إذا كنت بحاجة إلى سيولة نقدية واردة، يمكنك شرائها من الخدمات.

أليس تشتري قناة مع سوزي بمبلغ مليون ساتوشي، لذا تفتح قناة مع 1،000،000 سات من الجانب الوارد مباشرة. يمكنها بعد ذلك قبول ما يصل إلى مليون ساتوشي من الدفعات من العملاء الذين يكونون متصلين بسوزي (والتي تكون متصلة جدًا).

حل آخر سيكون عمل دفعات؛ تدفع 100،000 لسبب ما، وبعد ذلك يمكنك استلام 100،000.

### حل الحلقة الخارجية: Atomic swap LN - BTC

أليس 2 مليون - سوزي 0

أليس ترغب في إرسال السيولة إلى سوزي، لذا تقوم بعمل حلقة خارجية (عقدة خاصة تقدم خدمة إعادة توازن LN/BTC).
أليس ترسل مليون واحد إلى الحلقة عبر عقدة سوزي، لذا يكون لدى سوزي السيولة وتعيد الحلقة التوازن على السلسلة إلى عقدة أليس.

لذا، يذهب المليون إلى سوزي، وترسل هذه الأخيرة مليونًا إلى الحلقة، وترسل الحلقة مليونًا إلى أليس. لذا، نقلت أليس السيولة إلى سوزي مقابل بعض الرسوم المدفوعة للحلقة عن الخدمة.

الأكثر تعقيدًا في LN هو الحفاظ على السيولة.

في الختام، إدارة السيولة على شبكة Lightning Network هي قضية رئيسية، وتعتمد على نوع المستخدم: المشتري، التاجر أو عقدة التوجيه. المشترين، الذين يحتاجون إلى سيولة صادرة، لديهم المهمة الأسهل: يقومون بفتح القنوات ببساطة. التجار، الذين يحتاجون إلى سيولة واردة، يجب أن يكونوا متصلين بعقدات وأطراف أخرى. عقدات التوجيه، بدورها، تسعى للحفاظ على توازن السيولة من الجانبين. هناك العديد من الحلول المتاحة لإدارة السيولة، مثل شراء القنوات أو الدفع لزيادة القدرة على الاستقبال. خيار "حلقة خارجية"، الذي يسمح بـ Atomic Swap بين LN و BTC، يوفر حلاً مثيرًا للاهتمام لإعادة توازن السيولة. على الرغم من هذه الاستراتيجيات، إلا أن الحفاظ على السيولة على شبكة Lightning Network يظل تحديًا معقدًا.

# اذهب أبعد من ذلك

## ملخص للتدريب

كان هدفنا هو شرح كيفية عمل شبكة Lightning وكيف تعتمد على بيتكوين للعمل.
شبكة البرق هي شبكة من قنوات الدفع. لقد رأينا كيف تعمل قناة الدفع بين جانبين، ولكننا أيضًا قمنا بتوسيع رؤيتنا لتشمل الشبكة بأكملها ومفهوم شبكة قنوات الدفع.

تتم فتح القنوات عن طريق عملية تحويل بيتكوين ويمكن أن تستوعب أي عدد من العمليات الممكنة. يتم تمثيل حالة القناة بواسطة عملية التزام ترسل لكل طرف ما لديه من جانب القناة. عندما يحدث تحويل داخل القناة، يلتزم الأطراف بالحالة الجديدة عن طريق إلغاء الحالة القديمة وبناء عملية تزام جديدة.

تحمي الأزواج أنفسهم من الغش باستخدام مفاتيح الإلغاء والقفل الزمني. يفضل إغلاق القناة بالتراضي المتبادل. في حالة الإغلاق القسري، يتم نشر آخر عملية تزام.

يمكن للمدفوعات أن تستخدم قنوات العقد الذكية للمرور عبر قنوات العقد الذكية الأخرى. يتيح الدفع المشروط على القنوات العقد الذكية (HTLC) تجميد الأموال حتى يتم حل الدفعة بالكامل. يتم استخدام التوجيه المتعدد الطبقات في شبكة البرق. لا يعرف العقد الذكي الوسيط الوجهة النهائية للمدفوعات. يجب على أليس حساب مسار الدفعة، لكنها ليست لديها كل المعلومات حول السيولة في القنوات الوسيطة.

هناك عنصر احتمالية عند إرسال دفعة عبر شبكة البرق.

لتلقي المدفوعات، يجب إدارة السيولة في القنوات، ويمكن القيام بذلك عن طريق طلب من الآخرين فتح قنوات إلينا، أو فتح قنوات بأنفسنا، واستخدام أدوات مثل Loop أو شراء/استئجار قنوات على المتاجر.

مقابلة مع فانيس

إليكم ملخص للمقابلة:

شبكة البرق هي حلاً للدفع السريع جدًا على بيتكوين يسمح بتجاوز القيود المتعلقة بقدرة الشبكة. ومع ذلك، فإن بيتكوين على البرق ليس بنفس قدر الأمان الذي يتمتع به على سلسلة الكتل لأن اللامركزية والأمان تعطى الأولوية على حساب القدرة على التوسع.

زيادة حجم الكتل بشكل مفرط ليست حلاً جيدًا لأنها تأتي مع تنازلات فيما يتعلق بالعقد وقدرة البيانات. بدلاً من ذلك، يسمح شبكة البرق بإنشاء قنوات دفع بين مستخدمين اثنين من بيتكوين دون ظهور المعاملات على سلسلة الكتل، مما يوفر مساحة في الكتل ويسمح لبيتكوين بالتوسع اليوم.
ومع ذلك، هناك انتقادات تتعلق بقابلية التوسع والتركيز في شبكة البرق، مع وجود مشاكل محتملة تتعلق بإغلاق القنوات وارتفاع رسوم المعاملات. لحل هذه المشاكل، يُوصَى بتجنب فتح قنوات صغيرة لتجنب المشاكل المستقبلية وزيادة رسوم المعاملات باستخدام "Child Pay for Parent".

الحلول المتوقعة لمستقبل شبكة البرق هي التجميع وإنشاء قنوات جماعية لتقليل رسوم المعاملات، بالإضافة إلى زيادة حجم الكتل على المدى البعيد. ومع ذلك، من المهم أن نلاحظ أن البيتكوين على البرق ليست آمنة بنفس قدر البيتكوين على سلسلة الكتل.

الخصوصية في البيتكوين والبرق مرتبطة، حيث يضمن التوجيه المتعدد الطبقات مستوى معينًا من الخصوصية للمعاملات. ومع ذلك، في البيتكوين، كل شيء شفاف بشكل افتراضي، مع استخدام القواعد الاحتمالية لتتبع البيتكوين من عنوان إلى عنوان على سلسلة الكتل.

يتيح شراء البيتكوين مع KYC للصرافة معرفة المعاملات المسحوبة، بينما تسمح المبالغ المستديمة وعناوين التغيير بمعرفة أي جزء من المعاملة موجه لشخص آخر وأي جزء موجه للشخص نفسه.

لتحسين الخصوصية، تسمح العمليات المشتركة والعمليات المشتركة بكسر حسابات الاحتمالية من خلال إجراء معاملات يشارك فيها عدة أشخاص معًا. وتواجه شركات تحليل سلاسل صعوبة أكبر في تحديد ما تفعله بيتكوين الخاص بك عن طريق تتبعه.

في البرق، هناك فقط شخصان يعلمان بالمعاملة وهو أكثر سرية من البيتكوين. يعني التوجيه المتعدد الطبقات أن العقدة الوسيطة لا تعرف المرسل والمستلم للدفعة.

لاستخدام شبكة البرق، يُوصَى باتباع دورة تدريبية على قناتك على YouTube أو مباشرة على موقع اكتشف بيتكوين، أو استخدام دورة تدريبية على Umbrell. كما يمكن إرسال نص تعسفي أثناء عملية الدفع على البرق باستخدام حقل مخصص لذلك، وهو مفيد للتبرعات أو للرسائل.

ومع ذلك، من المهم أن نلاحظ أنه يمكن تنظيم عقدات التوجيه على البرق في المستقبل، حيث ستحاول بعض الدول تنظيم عقدات التوجيه.

بالنسبة للتجار، من الضروري إدارة السيولة لقبول المدفوعات على شبكة البرق، مع وجود قيود حالية يمكن التغلب عليها بحلول مناسبة.

أخيرًا، فإن مستقبل البيتكوين واعد مع توقعات بالوصول إلى مليون دولار في خمس سنوات. لضمان تحقيق احترافية الصناعة وإنشاء نظام بديل للنظام المصرفي الحالي، من المهم المساهمة في الشبكة والتوقف عن الثقة.

## شكر واستمر في حفر جحر الأرنب

تهانينا! 🎉

لقد أنهيت دورة LN 201 - مقدمة في شبكة البرق!
يمكنك أن تفخر بنفسك لأنه ليس أمرًا سهلاً. تذكر أن القليل من الأشخاص ينزلون إلى هذا الحد في جحر البيتكوين.
أولاً وقبل كل شيء ، شكرًا جزيلاً لـ Fanis Makalakis لتقديم هذه الدورة المجانية الرائعة حول جانب أكثر عرقيًا للبرق. لا تتردد في متابعته على تويتر ، أو على مدونته ، أو من خلال عمله في LN market.

ثم ، إذا كنت ترغب في مساعدة المشروع ، فلا تتردد في رعايتنا على Patreon. ستستخدم تبرعاتك لإنتاج محتوى لتكوينات جديدة وبالطبع ، ستكون أول من يتم إبلاغه (بما في ذلك للتكوين القادم من Fanis الذي يتم التخطيط له حاليًا!).

مغامرة شبكة البرق مستمرة مع تكوين Umbrel وإعداد شبكة البرق. انتهت النظرية وحان الوقت للتطبيق العملي مع تكوين LN 202 الآن!

قبلات ونراكم قريبا جدا!

Rogzy